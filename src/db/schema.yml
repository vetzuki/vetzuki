- hosts: localhost
  vars:
    vetzuki_environment: poc
    aws_region: "us-west-2"
    public_ip: "71.204.152.97"
    db_reset: no
    db_triggers:
      update_timestamp: update_timestamp.sql
    tables:
      - name: employer
        columns:
          - id bigserial primary key
          - name text
          - billing_email text
          - billing_id bigint
          - billing_state int # 0:Paid, 1:Pending, 2:Owes, 3:Unconfirmed, 4:OneTime
          - created TIMESTAMPTZ NOT NULL DEFAULT NOW()
          - modified TIMESTAMPTZ NOT NULL DEFAULT NOW()
      - name: exam
        columns:
          - id bigserial primary key
          - name text # Describes the type of exam
          - description text
          - created TIMESTAMPTZ NOT NULL DEFAULT NOW()
          - modified TIMESTAMPTZ NOT NULL DEFAULT NOW()
      - name: employer_exam
        columns:
          - id bigserial primary key
          - exam_id bigint references exam(id)
          - employer_id bigint references employer(id)
          - created TIMESTAMPTZ NOT NULL DEFAULT NOW()
          - modified TIMESTAMPTZ NOT NULL DEFAULT NOW()
      - name: prospect
        columns:
          - id bigserial primary key
          - name text
          - email text
          - url text
          - employer_id bigint references employer(id)
          - employer_exam_id bigint references employer_exam(id)
          - created TIMESTAMPTZ NOT NULL DEFAULT NOW()
          - modified TIMESTAMPTZ NOT NULL DEFAULT NOW()
    rds:
      aws_access_key: "AKIAYSBEZFXG4OEJWLUE"
      aws_secret_key: "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"
      aws_region: "{{ aws_region }}"
      instance_name: "db-{{ vetzuki_environment }}"
      db_engine: postgres
      size: 10
      instance_type: db.t3.micro
      username: "{{ vetzuki_environment }}"
      master_user_password: vetzuk1p0c
      password: vetzuk1p0c
      tags:
        Environment: "{{ vetzuki_environment }}"
        Application: "vetzuki"
  tasks:
    - pip: name=psycopg2-binary
    - name: Gather RDS connection information
      command: 
        argv:
          - aws
          - rds
          - describe-db-instances
          - --region
          - "{{ rds.aws_region }}"
          # - "--query 'DBInstances[*]'"
      register: aws_output
      environment:
        AWS_ACCESS_KEY_ID: "{{ rds.aws_access_key }}"
        AWS_SECRET_ACCESS_KEY: "{{ rds.aws_secret_key }}"
        AWS_REGION: "{{ rds.aws_region }}"
    - set_fact:
        rds_instances: "{{ aws_output.stdout | from_json }}"
    - set_fact:
        db_host: "{{ rds_instances.DBInstances[0].Endpoint.Address }}"
        db_port: "{{ rds_instances.DBInstances[0].Endpoint.Port }}"
    - debug:
        msg: "Postgres URL: postgres://{{ db_host}}:{{ db_port }}"

    - name: Drop vetzuki database
      when: db_reset
      postgresql_db:
        name: vetzuki
        login_host: "{{ db_host }}"
        port: "{{ db_port }}"
        login_user: "{{ rds.username }}"
        login_password: "{{ rds.password }}"
        state: absent

    - name: Create vetzuki database
      postgresql_db:
        name: vetzuki
        login_host: "{{ db_host }}"
        port: "{{ db_port }}"
        login_user: "{{ rds.username }}"
        login_password: "{{ rds.password }}"

    - name: Create tables
      loop: "{{ tables }}"
      loop_control:
        loop_var: table
      postgresql_table:
        login_host: "{{ db_host }}"
        port: "{{ db_port }}"
        login_user: "{{ rds.username }}"
        login_password: "{{ rds.password }}"
        db: vetzuki
        name: "{{ table.name }}"
        state: present
        columns: "{{ table.columns }}"
    # Create trigger to update modified timestamp on row updates
    - name: Create set timestamp trigger
      postgresql_query:
        login_host: "{{ db_host }}"
        port: "{{ db_port }}"
        login_user: "{{ rds.username }}"
        login_password: "{{ rds.password }}"
        db: vetzuki
        path_to_script: "{{ ansible_env.PWD }}/{{ db_triggers.update_timestamp }}"
    - name: Attach set timestamp trigger
      loop: "{{ tables }}"
      loop_control:
        loop_var: table
      postgresql_query:
        login_host: "{{ db_host }}"
        port: "{{ db_port }}"
        login_user: "{{ rds.username }}"
        login_password: "{{ rds.password }}"
        db: vetzuki
        query: >
          CREATE TRIGGER set_timestamp
          BEFORE UPDATE ON {{ table.name }}
          FOR EACH ROW
          EXECUTE PROCEDURE trigger_set_timestamp();
